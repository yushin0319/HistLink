# HistLink プロジェクト全体インデックス

## プロジェクト概要

**HistLink（ヒストリンク）** - 日本史・西洋史の用語を連鎖的につなぐ歴史学習ゲーム

- **技術スタック**: Python (FastAPI) + PostgreSQL + React 19 + TypeScript + Vite + MUI
- **開発環境**: Docker (PostgreSQL 16)
- **テスト**: pytest (backend), Vitest + Testing Library (frontend)

---

## ディレクトリ構造

```
HistLink/
├── .claude/                    # Claude Code設定
│   ├── commands/
│   │   └── suggest-tasks.md
│   └── settings.local.json
│
├── .serena/                    # Serenaメモリ・設定
│   ├── failures/               # 失敗記録
│   ├── memories/               # プロジェクトメモリ
│   └── project.yml
│
├── backend/                    # Pythonバックエンド
│   ├── app/
│   │   ├── models/             # SQLAlchemyモデル
│   │   ├── routes/             # APIエンドポイント
│   │   │   ├── games.py        # ゲームAPI
│   │   │   └── routes.py       # ルートAPI
│   │   ├── schemas/            # Pydanticスキーマ
│   │   │   ├── game.py
│   │   │   ├── route.py
│   │   │   └── term.py
│   │   ├── services/           # ビジネスロジック
│   │   │   ├── route_generator.py    # ルート生成（BFS）
│   │   │   └── distractor_generator.py  # 不正解選択肢生成
│   │   ├── config.py           # 環境設定
│   │   ├── database.py         # DB接続管理
│   │   └── main.py             # FastAPIアプリ
│   ├── tests/                  # pytestテストスイート
│   │   ├── conftest.py
│   │   ├── test_database.py
│   │   ├── test_data_quality.py
│   │   ├── test_distractor_generator.py
│   │   ├── test_games_api.py
│   │   ├── test_routes_api.py
│   │   └── test_route_generator.py
│   └── pyproject.toml          # Python依存関係
│
├── data/                       # 単一の情報源（SSOT）
│   ├── terms.tsv               # 歴史用語データ（210件）
│   └── relations.tsv           # リレーションデータ（714件）
│
├── database/                   # データベース管理
│   ├── migrations/             # SQLマイグレーション
│   │   └── 001_create_tables.sql  # スキーマ定義 + データ投入
│   └── scripts/                # データ品質チェック
│       └── check_data_quality.sql
│
├── frontend/                   # React + TypeScript
│   ├── public/
│   ├── src/
│   │   ├── assets/
│   │   ├── components/         # Reactコンポーネント
│   │   │   ├── ChoiceCard.tsx  # 選択肢カード
│   │   │   ├── GameCard.tsx    # ゲームカード
│   │   │   └── __tests__/      # コンポーネントテスト
│   │   ├── test/
│   │   │   └── setup.ts
│   │   ├── App.tsx             # メインアプリ
│   │   └── main.tsx
│   ├── package.json
│   ├── vite.config.ts
│   └── vitest.config.ts
│
├── scripts/                    # 自動化スクリプト
│   └── update_migration.sh     # DB完全再構築スクリプト
│
├── .editorconfig               # エディタ設定（LF統一）
├── .gitattributes              # Git改行コード設定
├── .mcp.json                   # MCP設定（Serena, Notion）
├── CLAUDE.md                   # プロジェクト開発ルール
├── docker-compose.yml          # Docker設定
└── PLAN.md                     # 開発計画書
```

---

## データスキーマ

### terms.tsv（歴史用語）

| カラム | 型 | 説明 | 例 |
|--------|-----|------|-----|
| id | INTEGER | 用語ID（1-100: 日本史、101-200: 西洋史） | 1 |
| name | TEXT | 用語名 | 縄文時代 |
| era | TEXT | 時代区分 | 古代 |
| year | INTEGER | 年代（紀元前は負の数） | -14000 |
| tags | JSON配列 | タグ | ["先史", "文化"] |

**データ件数**: 210件

### relations.tsv（リレーション）

| カラム | 型 | 説明 | 例 |
|--------|-----|------|-----|
| src_id | INTEGER | 元の用語ID | 1 |
| dst_id | INTEGER | 行き先の用語ID | 11 |
| relation_type | TEXT | 関係の種類 | 契機 |
| keyword | TEXT | 関係のキーワード | 農耕開始 |
| explanation | TEXT | 説明文 | 狩猟採集から農耕社会への移行 |

**関係タイプ**: 因果, 契機, 対立, 政策, 文化, 同時代, 外交

**データ件数**: 714件

**制約**:
- 自己ループ禁止（src_id ≠ dst_id）
- すべての用語は degree ≥ 2（孤立ノード禁止）

---

## データベーススキーマ

### テーブル構成（PostgreSQL 16）

1. **terms** - 歴史用語
   - id (PRIMARY KEY)
   - name (TEXT, UNIQUE)
   - era (TEXT)
   - year (INTEGER)
   - tags (JSONB)

2. **relations** - 用語間の関係
   - id (SERIAL PRIMARY KEY)
   - src_id (FOREIGN KEY → terms.id)
   - dst_id (FOREIGN KEY → terms.id)
   - relation_type (TEXT)
   - keyword (TEXT)
   - explanation (TEXT)

3. **games** - ゲームセッション
   - id (UUID PRIMARY KEY)
   - score (INTEGER)
   - lives (INTEGER)
   - current_term_id (FOREIGN KEY → terms.id)
   - visited_term_ids (INTEGER[])
   - created_at (TIMESTAMP)
   - updated_at (TIMESTAMP)

---

## バックエンドAPI（FastAPI）

### エンドポイント

#### ゲームAPI（/api/games）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /api/games/start | 新規ゲーム開始 |
| GET | /api/games/{game_id} | ゲーム状態取得 |
| GET | /api/games/{game_id}/choices | 選択肢取得（正解1 + 不正解3） |
| POST | /api/games/{game_id}/answer | 回答送信 |

#### ルートAPI（/api/routes）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/routes | ルート生成（start_id, end_id, visitedパラメータ） |

### 主要サービス

1. **route_generator.py** - ルート生成ロジック（BFS）
   - `generate_route()`: 最適ルート生成
   - `calculate_bfs_distances()`: BFS距離計算
   - `calculate_score()`: スコアリング（三角形ヒット、距離、隣接数）

2. **distractor_generator.py** - 不正解選択肢生成
   - ERA戦略: 異なる時代の用語
   - TAG戦略: 異なるタグの用語
   - RANDOM戦略: ランダム

---

## フロントエンド（React 19 + TypeScript）

### 主要コンポーネント

1. **App.tsx** - メインアプリケーション
   - ゲーム状態管理
   - カード表示
   - 選択肢ハンドリング

2. **GameCard.tsx** - 現在のカード表示
   - 用語名、時代、年代表示
   - MUI Card使用

3. **ChoiceCard.tsx** - 選択肢カード
   - クリッカブルカード
   - ホバー効果

### テスト

- Vitest + Testing Library
- コンポーネントテスト: `__tests__/`ディレクトリ

---

## 開発フロー

### データベース操作

```bash
# Docker起動
docker compose up -d

# DB接続（ホストから）
PGPASSWORD=histlink_dev_password psql -h localhost -p 5432 -U histlink_user -d histlink

# TSVファイル更新後の必須作業
./scripts/update_migration.sh

# データ品質チェック
PGPASSWORD=histlink_dev_password psql -h localhost -p 5432 -U histlink_user -d histlink -f database/scripts/check_data_quality.sql
```

### バックエンド

```bash
cd backend

# テスト実行
pytest                              # 全テスト
pytest tests/test_data_quality.py -v  # データ品質テストのみ
pytest --cov=app --cov-report=html  # カバレッジ付き

# 開発サーバー
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### フロントエンド

```bash
cd frontend

# 開発サーバー
npm run dev

# テスト
npm test                   # Vitest実行
npm run test:coverage      # カバレッジ付き

# ビルド
npm run build
```

---

## データフロー

```
data/*.tsv (単一の情報源)
    ↓
scripts/update_migration.sh (DB完全再構築)
    ↓
database/migrations/001_create_tables.sql
    ↓
PostgreSQL (Docker)
    ↓
backend/app/ (FastAPI)
    ↓
frontend/ (React)
```

---

## 重要なルール

### 1. TSVファイル更新時の必須作業

**MUST**: `data/terms.tsv` または `data/relations.tsv` を更新したら：

```bash
# 1. データベース再構築
./scripts/update_migration.sh

# 2. データ品質チェック
cd backend && pytest tests/test_data_quality.py -v

# 3. 全テスト実行
pytest tests/ -v
```

### 2. 単一の情報源（SSOT）

- **データの実体**: `data/*.tsv`
- **ドキュメント**: スキーマ定義と使い方のみ
- **統計・件数**: SQL実行時に確認（ハードコード禁止）

### 3. ファイル作成ルール

**MUST**: 新しいファイルを作成する前に、必ずユーザーに確認：
1. ファイル名（命名規則）
2. 配置場所（ディレクトリ構造）
3. 既存ファイルとの統合可能性

---

## テスト構成

### Backend（pytest）

- **test_database.py**: DB接続テスト
- **test_data_quality.py**: データ品質テスト（210 terms, 714 relations, degree ≥ 2）
- **test_games_api.py**: ゲームAPIテスト
- **test_routes_api.py**: ルートAPIテスト
- **test_route_generator.py**: ルート生成ロジックテスト
- **test_distractor_generator.py**: 不正解生成ロジックテスト

### Frontend（Vitest）

- **ChoiceCard.test.tsx**: 選択肢カードコンポーネントテスト
- **GameCard.test.tsx**: ゲームカードコンポーネントテスト

---

## MCP設定

### 接続済みMCPサーバー

1. **Serena** - コードベース探索・編集
   - コンテキスト: ide-assistant
   - モード: interactive, editing

2. **Notion** - タスク管理（Acala workspace）
   - use-notionスキル経由で操作必須

---

## 設定ファイル

- **.editorconfig**: 改行コードLF統一、インデント設定
- **.gitattributes**: Git改行コード強制（LF）
- **.mcp.json**: MCP設定（Serena, Notion）
- **docker-compose.yml**: PostgreSQL 16 (Alpine)
- **pyproject.toml**: Python依存関係（FastAPI, SQLAlchemy, pytest）
- **package.json**: Node.js依存関係（React 19, Vite, MUI, Vitest）

---

## 更新日

**2025-11-16**: プロジェクト全体インデックス作成
